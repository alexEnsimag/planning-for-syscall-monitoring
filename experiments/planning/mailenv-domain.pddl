(define (domain mailenv-syscalls)
    (:requirements :adl)

    (:types
        fd ; file descriptor (file or socket only)
        path ; path of a file
        socket-type ; socket type
        ioctl-command 
        integer
        port
    )

  	(:constants ; integers
  				n0 - integer
    			n1 - integer
                n2 - integer
                n3 - integer
                n5 - integer
               	n6 - integer
    			n14 - integer
                n15 - integer
             	n18 - integer
                n29 - integer
                n31 - integer
             	n34 - integer
    			n37 - integer
                n39 - integer
                n48 - integer
                n50 - integer
     			n53 - integer
                n54 - integer
                n55 - integer
                n56 - integer
                n58 - integer
                n59 - integer
                n60 - integer
                n61 - integer
                n62 - integer
                n63 - integer
    			n65 - integer  
                n79 - integer
                n92 - integer
                n118 - integer
                n121 - integer
                n147 - integer
                nEAGAIN - integer ; read with res=-11  
                nFAIL - integer
                ; file descriptors
                fd0 - fd
                fd1 - fd
                fd2 - fd
                fdFAIL - integer   
                ; socket types
                AF_LOCAL - socket-type
                SOCKTYPE_NOT_SUPPORTED - socket-type 
                ; ioctl commands
                FIONREAD - ioctl-command
                COMMAND_NOT_SUPPORTED - ioctl-command  
               	; paths
               	cleanup - path
               	fetchmail - path
                fetchmail_logfile - path
                etc_localtime - path
                NO_PATH - path
               	; ports
               	p25 - port
               	p143 - port
                NO_PORT - port  
  	)


  	(:predicates
        (opened ?fd - fd)
        (file-fd ?fd - fd)
      	(related-file ?fd - fd ?path - path)
        (local-socket ?fd - fd)
        (inet-socket ?fd - fd)
        (pipe-fd ?fd - fd)
        (smtp-connection ?fd - fd)
        (imap-connection ?fd - fd)
        (noeffect)

   		(email-in-transfer ?fd - fd)
        (fetchmail-gmx-email-transferred)
        (fetchmail-server-email-transferred)
        (imap-login-email-transferred)
		(smtpd-email-transferred)

        ; fetchmail
        (setitimer-1)
        (setitimer-2)
        (setitimer-3)
        (setitimer-n)
        (rt-sigaction-1)
        (rt-sigaction-2)

        ; fetchmail gmx
        (command-received ?fd - fd)
        (header-requested-fetchmail ?fd - fd)
        (header-sent-fetchmail ?fd - fd)
        (header-ack ?fd - fd)
        (body-requested-fetchmail ?fd - fd)
        (reading-body ?fd - fd)
        (reading-first-chunk ?fd - fd)
        (body-chunk-read-1 ?fd - fd)
        (body-chunk-read-2 ?fd - fd)
        (body-chunk-read-3 ?fd - fd)
        (body-chunk-read-4 ?fd - fd)
        (body-chunk-written-1 ?fd - fd)
        (body-chunk-written-2 ?fd - fd)
        (body-chunk-written-3 ?fd - fd)
        (body-chunk-written-4 ?fd - fd)
        (body-sent-fetchmail ?fd - fd)
     	(storage-requested-fetchmail ?fd - fd)
        (fetchmail-cloned)
        (pipe-input-closed)
        (subprocess-created)
        (subprocess-ended)
        (written-to-logs)
        (stat-localtime-1)
        (stat-localtime-2)

        ; fetchmail server
        (mail-from-sent ?fd - fd)
        (mail-from-ack-1 ?fd - fd)
        (mail-from-ack-2 ?fd - fd)
        (rcpt-to-sent ?fd - fd)
        (rcpt-to-ack-1 ?fd - fd)
        (rcpt-to-ack-2 ?fd - fd)
        (data-flag-sent ?fd - fd) ; smtp 'DATA' flag
        (end-data-flag-sent-fetchmail ?fd - fd) ; flag of end of data transfer
        (end-data-flag-ack-1 ?fd - fd)
        (end-data-flag-ack-2 ?fd - fd)
        (data-sent-fetchmail-1 ?fd - fd)
        (data-sent-fetchmail-2 ?fd - fd)
        (data-info1-sent ?fd - fd)
        (data-info2-sent ?fd - fd)
        (command-received-server ?fd - fd)
        (header-requested-1 ?fd - fd)
        (header-requested-2 ?fd - fd)
        (header-requested-3 ?fd - fd)
        (body-requested-server ?fd - fd)
        (storing-email-1 ?fd - fd)
        (storing-email-2 ?fd - fd)
        (init-transfer-fetchmail ?fd - fd)
        (data-sent-fetchmail ?fd - fd)

        ; imap login
     	(start-request ?fd - fd)
        (start-request-2 ?fd - fd)
        (data-read-imaplogin ?fd - fd)
        (data-sent ?fd - fd)
        (fetching-data ?fd - fd)
        (end-fetching-header ?fd - fd)
        (end-fetching-header-2 ?fd - fd)
        (header-requested-imaplogin ?fd - fd)
        (header-sent-imaplogin ?fd - fd)
        (body-requested-imaplogin ?fd - fd)
        (body-sent-imaplogin ?fd - fd)
        (storage-requested-imaplogin ?fd - fd)
        (storing-email ?fd - fd)
        (storage-done ?fd - fd)
        (expunge-requested ?fd - fd)
        (expunging-email ?fd - fd)
        (expunge-done ?fd - fd)
        (setsockopt-done)
        (epoll_wait-done)

        ; smtpd
    	(event-received ?fd - fd)
        (mail-from-received ?fd - fd) ; data read, if statfs after it means beginning of email transfer
    	(mail-from-ack ?fd - fd)
        (rcpt-to-received ?fd - fd)
        (rcpt-to-ack ?fd - fd)
        (data-received ?fd - fd) ; smtp 'DATA' flag
        (end-data-flag-sent ?fd - fd) ; flag of end of data transfer
        (init-transfer ?fd - fd)
        (transfer-started ?fd - fd)
        (data-read-smtpd ?fd - fd) ; from smtp connection
        (data-queued ?fd - fd) ; to cleanup
        (end-queuing ?fd - fd)
        (cleanup ?fd - fd)
        (cleanup-started ?fd - fd)
        (cleanup-queue-id-received ?fd - fd)
        (cleanup-flags-178-sent ?fd - fd)
        (cleanup-done ?fd - fd)
        (statfs-done ?fd - fd)
        (ioctl-done ?fd - fd)
    )

  	; syscalls not implemented are replaced by the action "notimplemented" which has no effect
   	(:action notimplemented 
        :parameters     ()
        :precondition   ()
        :effect         (noeffect)
    )


    ; syscalls not implemented are replaced by the action "notimplemented" which has no effect
    (:action nanosleep 
        :parameters     ()
        :precondition   ()
        :effect         (noeffect)
    )


    (:action clone
        :parameters     (?exe - path ?res - integer)
        :precondition   ()
        :effect         (when   (and    (not (= ?res nFAIL))
                                        (= ?exe fetchmail))
                                (fetchmail-cloned))
    )

    (:action close
    	:parameters 	(?fd - fd ?res - integer)
    	:precondition 	()
    	:effect 		(and	(when   (and    (not (= ?res nFAIL))
                                                (opened ?fd))
                                        (and    (not (opened ?fd))
                                                (not (pipe-fd ?fd))
                                                (not (file-fd ?fd))
                                                (not (local-socket ?fd))
                                                (not (inet-socket ?fd))
                                                (not (imap-connection ?fd))
                                                (not (email-in-transfer ?fd ))))
    	                      	; fetchmail gmx
								(when   (and    (not (= ?res nFAIL))
                                                (opened ?fd)
                                                (fetchmail-cloned)
                                                (pipe-fd ?fd))
                                        (pipe-input-closed))
                                (when   (and    (not (= ?res nFAIL))
                                                (opened ?fd)
                                                (pipe-fd ?fd)
                                                (body-sent-fetchmail ?fd))
                                        (and    (not (body-sent-fetchmail ?fd))
                                                (not (subprocess-created))
                                                (subprocess-ended)))
                                ; smtpd
                              	(when 	(and 	(not (= ?res fdFAIL))
                                                (opened ?fd)
    											(cleanup ?fd)
                                                (end-queuing ?fd))
    									(and 	(not (end-queuing ?fd))
    											(not (cleanup ?fd))
                                                (cleanup-done ?fd))))
    )

    (:action connect
        :parameters     (?fd - fd ?path - path ?port - port ?res - integer)
        :precondition   ()
        :effect         (and    (when   (and    (not (= ?res nFAIL))
                                                (local-socket ?fd)
                                                (statfs-done ?fd)
                                                (= ?path cleanup))
                                        (and    (cleanup ?fd)
                                                (cleanup-started ?fd)
                                                (not (statfs-done ?fd))))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?port p25))
                                        (smtp-connection ?fd)))
    )


    (:action epoll_wait 
        :parameters     (?res - integer)
        :precondition   ()
        :effect         (when   (and    (not (= ?res nFAIL))
                                        (not (=?res n0)))
                                (epoll_wait-done))
    )


 	(:action ioctl 
        :parameters     (?fd - fd ?request - ioctl-command ?res - integer)
        :precondition   ()
        :effect         (when   (and    (not (= ?res fdFAIL))
                                        (or (mail-from-received ?fd) (data-received ?fd))
                                        (= ?request FIONREAD)
                                        (exists (?fd2 - fd) (cleanup-flags-178-sent ?fd2)))
                                (ioctl-done ?fd))
    )


    (:action pipe
        :parameters     (?fd1 - fd ?fd2 - fd ?res - integer)
        :precondition   ()
        :effect         (when   (not (= ?res nFAIL))
                                (and    (opened ?fd1)
                                        (pipe-fd ?fd1)
                                        (opened ?fd2)
                                        (pipe-fd ?fd2)
                                        (not (setitimer-n)))) ; TODO: to be fixed if syscalls happening before pipe are implemented
    )


    (:action poll
        :parameters     (?fd - fd ?res - integer)
        :precondition   ()
        :effect         (when   (and    (not (= ?res n0))
                                        (not (= ?res nFAIL)))   
                                (event-received ?fd))
    )


    (:action recvfrom
        :parameters     (?fd - fd ?res - integer)
        :precondition   ()
        :effect         (and    (when   (and    (not (= ?res nFAIL))
                                                (= ?res n14) 
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (mail-from-sent ?fd)) 
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (mail-from-sent ?fd))
                                                (mail-from-ack-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n14) 
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (rcpt-to-sent ?fd)) 
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (rcpt-to-sent ?fd))
                                                (rcpt-to-ack-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n37) 
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (end-data-flag-sent-fetchmail ?fd)) 
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (end-data-flag-sent-fetchmail ?fd))
                                                (end-data-flag-ack-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n34) 
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (storing-email-1 ?fd)) 
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (storing-email-1 ?fd))
                                                (storing-email-2 ?fd)))
                        )
    )


    (:action rt_sigaction
        :parameters     ()
        :precondition   ()
        :effect         (and    ; rt_sigaction 1
                                (when   (and    (not (rt-sigaction-1))
                                                (not (rt-sigaction-2)))
                                        (rt-sigaction-1))
                                ; rt_sigaction 2
                                (when   (and    (rt-sigaction-1)
                                                (not (fetchmail-cloned))
                                                (not (pipe-input-closed)))
                                        (and    (not (rt-sigaction-1))
                                                (rt-sigaction-2)))
                                (when   (and    (rt-sigaction-1)
                                                (fetchmail-cloned)
                                                (pipe-input-closed))
                                        (and    (not (rt-sigaction-1))
                                                (not (fetchmail-cloned))
                                                (not (pipe-input-closed))
                                                (subprocess-created)))
                                (when   (rt-sigaction-2)
                                        (not (rt-sigaction-2)))
                        )
    )


    (:action sendto 
        :parameters     (?fd - fd ?res - integer)
        :precondition   ()
        :effect         (and    (when   (and    (not (= ?res nFAIL))
                                                (= ?res n29))
                                        (header-requested-imaplogin ?fd))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n31)
                                                (header-sent-imaplogin ?fd))
                                        (and    (not (header-sent-imaplogin ?fd))
                                                (body-requested-imaplogin ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n39)
                                                (body-sent-imaplogin ?fd))
                                        (and    (not (body-sent-imaplogin ?fd))
                                                (storage-requested-imaplogin ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n15)
                                                (storage-done ?fd))
                                        (and    (not (storage-done ?fd))
                                                (expunge-requested ?fd))))
    )

    (:action setitimer
        :parameters     ()
        :precondition   ()
        :effect         (and    (when   (and    (not (setitimer-1))
                                                (not (setitimer-2))
                                                (not (setitimer-3))
                                                (not (setitimer-n)))
                                        (setitimer-1))
                                (when   (setitimer-1)
                                        (and    (not (setitimer-1))
                                                (setitimer-2)))
                                (when   (setitimer-2)
                                        (and    (not (setitimer-2))
                                                (setitimer-3)))
                                (when   (setitimer-3)
                                        (and    (not (setitimer-3))
                                                (setitimer-n))))
    )


    (:action setsockopt 
        :parameters     ()
        :precondition   ()
        :effect         (and    (setsockopt-done)
                                (forall     (?fd - fd)
                                    (when   (and    (exists (?fd2 - fd)
                                                            (and    (local-socket ?fd2)
                                                                    (fetching-data ?fd2)))
                                                    (imap-connection ?fd)
                                                    (or (header-requested-imaplogin ?fd) (body-requested-imaplogin ?fd)))
                                            (fetching-data ?fd)))
                        )
    )


    (:action socket
        :parameters     (?dom - socket-type ?res - fd)
        :precondition   ()
        :effect         (and    (when 	(and    (not (= ?res fdFAIL))
                                                (not (opened ?res)))
        								(opened ?res))
                                (when   (and 	(not (= ?res fdFAIL))
                                                (not (opened ?res))
                                				(= ?dom AF_LOCAL))
                                        (local-socket ?res)))
    )


    (:action stat
        :parameters     (?path - path ?res - integer)
        :precondition   ()
        :effect         (and    (when   (and    (not (= ?res nFAIL))
                                                (= ?path etc_localtime)
                                                (exists (?fd - fd) (data-info1-sent ?fd))
                                                (not (stat-localtime-1)))
                                        (stat-localtime-1))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?path etc_localtime)
                                                (exists (?fd - fd) (data-info1-sent ?fd))
                                                (stat-localtime-1))
                                        (and    (not (stat-localtime-1))
                                                (stat-localtime-2)))
                        )
    )


	(:action statfs
        :parameters     ()
        :precondition   ()
        :effect 		(forall (?fd - fd)
                           	(when	(and 	(smtp-connection ?fd)
                           					(mail-from-received ?fd))  
                           			(statfs-done ?fd))
                       	)     
	)


    (:action read
        :parameters     (?fd - fd ?res - integer)
        :precondition   ()
        :effect         ; ------------------------------------------
        				; SMTPD
        				; ------------------------------------------
        				; begin email transfer
                        (and    (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (smtp-connection ?fd)
                                                (not (email-in-transfer ?fd)))
                                        (and    (mail-from-received ?fd)
                                                (email-in-transfer ?fd)))
                                ; ack MAIL FROM -> receive RCPT TO
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (mail-from-ack ?fd))
                                        (and    (rcpt-to-received ?fd)
                                                (not (mail-from-ack ?fd))))
                                ; ack RCPT TO -> received DATA          
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (rcpt-to-ack ?fd)
                                                (= ?res n6))
                                        (and    (data-received ?fd)
                                                (not (rcpt-to-ack ?fd))))
                                ; received end data flag -> read Delivered-To and Received: from 
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (end-data-flag-sent ?fd))
                                        (and    (init-transfer ?fd)
                                                (not (end-data-flag-sent ?fd))))
                                ; start reading email data
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (init-transfer ?fd)
                                                (exists (?fd2 - fd) (and (cleanup ?fd2) (transfer-started ?fd2))))
                                        (and    (data-read-smtpd ?fd)
                                                (not (init-transfer ?fd))))
                                ; reading email data
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (exists (?fd2 - fd) (and (cleanup ?fd2) (data-queued ?fd2))))
                                        (data-read-smtpd ?fd))
                                (forall (?fd2 - fd) 
                                        (when   (and (cleanup ?fd2) (data-queued ?fd2))
                                                (not (data-queued ?fd2))))
                                ; CLEANUP
                                ; received queuing_id
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (cleanup ?fd)
                                                (cleanup-started ?fd))
                                        (and    (not (cleanup-started ?fd))
                                                (cleanup-queue-id-received ?fd)))
                                ; queuing body -> end queuing
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (cleanup ?fd)
                                                ;(data-queued ?fd) doesn't work for smtpd_server4_410.csv
                                                (= ?res n18))
                                        (and    (end-queuing ?fd)
                                                (not (data-queued ?fd))))
                                ; RESET event received     
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd))  
                                        (not (event-received ?fd)))
								; ------------------------------------------
    							; FETCHMAIL GMX
    							; ------------------------------------------
    							(when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (= ?res n5))
                                        (command-received ?fd))
                                ; reading header
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-1)
                                                (imap-connection ?fd)
                                                (header-requested-fetchmail ?fd)
                                                (command-received ?fd))
                                        (and    (not (setitimer-1))
                                                (not (header-requested-fetchmail ?fd))
                                                (not (command-received ?fd))
                                                (header-sent-fetchmail ?fd)))
                                ; ack header
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-3)
                                                (subprocess-created)
                                                (imap-connection ?fd)
                                                (header-sent-fetchmail ?fd)
                                                (= ?res n50))
                                        (and    (not (setitimer-3))
                                                (not (header-sent-fetchmail ?fd))
                                                (header-ack ?fd)))
                                ; start transfer body chunk
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-1)
                                                (imap-connection ?fd)
                                                (command-received ?fd)
                                                (body-requested-fetchmail ?fd)
                                                (not (= ?res n5))) ; command and not data
                                        (and    (not (setitimer-1))
                                                (not (command-received ?fd))
                                                (not (body-requested-fetchmail ?fd))
                                                (reading-body ?fd)
                                                (reading-first-chunk ?fd)
                                                (body-chunk-read-1 ?fd)))
                                ; ; body chunk 1
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (= ?res n5)
                                                (reading-first-chunk ?fd))
                                        (not    (reading-first-chunk ?fd)))
                                ; reading next body chunk
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-n)
                                                (imap-connection ?fd)
                                                (command-received ?fd)
                                                (reading-body ?fd)
                                                (not (= ?res n5)) ; command and not data
                                                (not (= ?res n50)) ; not the beginning of a new chunk, end of body transfer
                                                (exists (?fd2 - fd) 
                                                        (and    (pipe-fd ?fd2)
                                                                (or (body-chunk-written-3 ?fd2) 
                                                                    (body-chunk-written-4 ?fd2))))) 
                                        (and    (not (setitimer-n))
                                                (not (command-received ?fd))
                                                (body-chunk-read-1 ?fd)))
                                ; body chunk 2
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (body-chunk-read-1 ?fd))
                                        (and    (not (body-chunk-read-1 ?fd))
                                                (body-chunk-read-2 ?fd)))
                                ; body chunk 3
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (body-chunk-read-2 ?fd))
                                        (and    (not (body-chunk-read-2 ?fd))
                                                (body-chunk-read-3 ?fd)))
                                ; body chunk 4
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (body-chunk-read-3 ?fd))
                                        (and    (not (body-chunk-read-3 ?fd))
                                                (body-chunk-read-4 ?fd)))
                                ; no more than body chunk 3 - negate chunk transfer
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (body-chunk-read-4 ?fd)
                                                (not (reading-first-chunk ?fd)))
                                        (not (body-chunk-read-4 ?fd)))
                                ; end body transfer
                                (when   (and    (not (= ?res nFAIL))
                                                (or (setitimer-3) (setitimer-n))
                                                (imap-connection ?fd)
                                                (command-received ?fd)
                                                (reading-body ?fd)
                                                (= ?res n50))
                                        (and    (not (setitimer-3))
                                                (not (setitimer-n))
                                                (not (command-received ?fd))
                                                (not (reading-body ?fd))
                                                (body-sent-fetchmail ?fd)))
                                ; storage done
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-1)
                                                (imap-connection ?fd)
                                                (storage-requested-fetchmail ?fd))
                                        (and    (not (setitimer-1))
                                                (not (storage-requested-fetchmail ?fd))
                                                (not (email-in-transfer ?fd))
                                                (fetchmail-gmx-email-transferred)))
		                       	; ------------------------------------------
		        				; IMAP LOGIN
		        				; ------------------------------------------
								; request 1
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (setsockopt-done)
                                                (epoll_wait-done)
                                                (= ?res n5))
                                        (and    (not (setsockopt-done))
                                                (not (epoll_wait-done))
                                                (start-request ?fd)))
                                ; request 2
                                (when   (and    (not (= ?res nFAIL))
                                                (start-request ?fd)
                                                (or (= ?res n53)
                                                    (= ?res n55)
                                                    (= ?res n63)
                                                    (= ?res n39)))
                                        (and    (not (start-request ?fd))
                                                (start-request-2 ?fd)))
                                ; request (header)
                                (when   (and    (= ?res nEAGAIN)
                                                (start-request-2 ?fd)
                                                (not (header-requested-imaplogin ?fd))
                                                (exists (?fd2 - fd) 
                                                        (and    (local-socket ?fd2)
                                                                (header-requested-imaplogin ?fd2))))
                                        (and    (not (start-request-2 ?fd))
                                                (header-requested-imaplogin ?fd)))
                                ; start fetching header - local socket
                                (when   (and    (not (= ?res nFAIL))
                                                (epoll_wait-done)
                                                (local-socket ?fd)
                                                (or (header-requested-imaplogin ?fd)  (body-requested-imaplogin ?fd)))
                                        (and    (not (epoll_wait-done))
                                                (fetching-data ?fd)
                                                (data-read-imaplogin ?fd)))
                                ; fetching data
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (fetching-data ?fd)
                                                        (not (data-read-imaplogin ?fd))
                                                        (not (= ?res nEAGAIN))
                                                        (not (= ?res nFAIL))
                                                        (imap-connection ?fd2)
                                                        (fetching-data ?fd2)
                                                        (data-sent ?fd2))
                                                (and    (not (data-sent ?fd2))
                                                        (data-read-imaplogin ?fd))))   
                                ; end fetching header 1 - 1st path
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (header-requested-imaplogin ?fd)
                                                        (fetching-data ?fd)
                                                        (not (data-read-imaplogin ?fd))
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (header-requested-imaplogin ?fd2)
                                                        (fetching-data ?fd2)
                                                        (data-sent ?fd2))
                                                (and    (not (setsockopt-done))
                                                        (not (data-sent ?fd2))
                                                        (not (header-requested-imaplogin ?fd))
                                                        (not (fetching-data ?fd))
                                                        (end-fetching-header ?fd)
                                                        (not (header-requested-imaplogin ?fd2))
                                                        (not (fetching-data ?fd2))
                                                        (end-fetching-header ?fd2)))) 
                                ; end fetching header 2 - 'OK Fetch completed' - 1st path
                                (when   (and    (not (= ?res nFAIL))
                                                (setsockopt-done)
                                                (epoll_wait-done)
                                                (= ?res n48)
                                                (end-fetching-header ?fd))
                                        (and    (not (setsockopt-done))
                                                (not (epoll_wait-done))
                                                (not (end-fetching-header ?fd))
                                                (end-fetching-header-2 ?fd)))
                                ; fetching header complete - 1st path
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (end-fetching-header-2 ?fd)
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (end-fetching-header-2 ?fd2))
                                                (and    (not (end-fetching-header-2 ?fd))
                                                        (header-sent-imaplogin ?fd)
                                                        (not (end-fetching-header-2 ?fd2))
                                                        (header-sent-imaplogin ?fd2)))) 
                                ; fetching header complete - 2nd path
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (header-requested-imaplogin ?fd)
                                                        (fetching-data ?fd)
                                                        (not (data-read-imaplogin ?fd))
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (header-requested-imaplogin ?fd2)
                                                        (fetching-data ?fd2)
                                                        (data-sent ?fd2))
                                                (and    (not (setsockopt-done))
                                                        (not (data-sent ?fd2))
                                                        (not (header-requested-imaplogin ?fd))
                                                        (not (fetching-data ?fd))
                                                        (header-sent-imaplogin ?fd)
                                                        (not (header-requested-imaplogin ?fd2))
                                                        (not (fetching-data ?fd2))
                                                        (header-sent-imaplogin ?fd2)))) 
                                ; request (body)
                                (when   (and    (= ?res nEAGAIN)
                                                (start-request-2 ?fd)
                                                (header-sent-imaplogin ?fd)
                                                (not (body-requested-imaplogin ?fd))
                                                (exists (?fd2 - fd) 
                                                        (and    (local-socket ?fd2)
                                                                (body-requested-imaplogin ?fd2))))
                                        (and    (not (start-request-2 ?fd))
                                                (not (header-sent-imaplogin ?fd))
                                                (body-requested-imaplogin ?fd)))
                                ; fetching body complete
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (body-requested-imaplogin ?fd)
                                                        (fetching-data ?fd)
                                                        (not (data-read-imaplogin ?fd))
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (body-requested-imaplogin ?fd2)
                                                        (fetching-data ?fd2)
                                                        (data-sent ?fd2))
                                                (and    (not (setsockopt-done))
                                                        (not (data-sent ?fd2))
                                                        (not (body-requested-imaplogin ?fd))
                                                        (not (fetching-data ?fd))
                                                        (body-sent-imaplogin ?fd)
                                                        (not (body-requested-imaplogin ?fd2))
                                                        (not (fetching-data ?fd2))
                                                        (body-sent-imaplogin ?fd2)))) 
                                ; request (storage)
                                (when   (and    (= ?res nEAGAIN)
                                                (start-request-2 ?fd)
                                                (body-sent-imaplogin ?fd)
                                                (not (storage-requested-imaplogin ?fd))
                                                (exists (?fd2 - fd) 
                                                        (and    (local-socket ?fd2)
                                                                (storage-requested-imaplogin ?fd2))))
                                        (and    (not (start-request-2 ?fd))
                                                (not (body-sent-imaplogin ?fd))
                                                (storage-requested-imaplogin ?fd)))
                                ; storing email (local socket)
                                (when   (and    (not (= ?res nFAIL))
                                                (epoll_wait-done)
                                                (local-socket ?fd)
                                                (storage-requested-imaplogin ?fd)
                                                (or (= ?res n92) (= ?res n118)))
                                        (and    (not (epoll_wait-done))
                                                (not (storage-requested-imaplogin ?fd))
                                                (storing-email ?fd)))
                                ; ending storage
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (storing-email ?fd)
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (storing-email ?fd2))
                                                (and    (not (storing-email ?fd))
                                                        (storage-done ?fd)
                                                        (not (storing-email ?fd2))
                                                        (storage-done ?fd2)))) 
                                ; request (expunge)
                                (when   (and    (= ?res nEAGAIN)
                                                (start-request-2 ?fd)
                                                (storage-done ?fd)
                                                (not (expunge-requested ?fd))
                                                (exists (?fd2 - fd) 
                                                        (and    (local-socket ?fd2)
                                                                (expunge-requested ?fd2))))
                                        (and    (not (start-request-2 ?fd))
                                                (expunge-requested ?fd)))
                                ; expunging email (local socket)
                                (when   (and    (not (= ?res nFAIL))
                                                (epoll_wait-done)
                                                (local-socket ?fd)
                                                (expunge-requested ?fd)
                                                (or (= ?res n54) (= ?res n55) (= ?res n56)))
                                        (and    (not (epoll_wait-done))
                                                (not (expunge-requested ?fd))
                                                (expunging-email ?fd)))
                                ; ending expunge
                                (forall (?fd2 - fd)
                                        (when   (and    (local-socket ?fd)
                                                        (expunging-email ?fd)
                                                        (= ?res nEAGAIN)
                                                        (imap-connection ?fd2)
                                                        (expunging-email ?fd2))
                                                (and    (not (expunging-email ?fd))
                                                        (expunge-done ?fd)
                                                        (not (expunging-email ?fd2))
                                                        (expunge-done ?fd2)
                                                        (imap-login-email-transferred))))
                                ; ------------------------------------------
                                ; FETCHMAIL SERVER
                                ; ------------------------------------------ 
                                ; mail from ack
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n14) 
                                                (smtp-connection ?fd)
                                                (mail-from-ack-1 ?fd)) 
                                        (and    (not (mail-from-ack-1 ?fd))
                                                (mail-from-ack-2 ?fd)))
                                ; rcpt to ack
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n14) 
                                                (smtp-connection ?fd)
                                                (rcpt-to-ack-1 ?fd)) 
                                        (and    (not (rcpt-to-ack-1 ?fd))
                                                (rcpt-to-ack-2 ?fd)))
                                ; end data flag ack
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n37) 
                                                (smtp-connection ?fd)
                                                (end-data-flag-ack-1 ?fd)) 
                                        (and    (not (end-data-flag-ack-1 ?fd))
                                                (end-data-flag-ack-2 ?fd)))
                                ; request header
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n5)
                                                (imap-connection ?fd)
                                                (or (setitimer-1) (setitimer-3)))
                                        (command-received-server ?fd))
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (command-received-server ?fd)
                                                (not (email-in-transfer ?fd))
                                                (or (setitimer-1) (setitimer-3))
                                                (not (header-requested-2 ?fd))
                                                (exists (?fd2 - fd) (data-info2-sent ?fd2)))
                                        (and    (not (command-received-server ?fd))
                                                (not (setitimer-1))
                                                (not (setitimer-3))
                                                (email-in-transfer ?fd)
                                                (header-requested-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (command-received-server ?fd)
                                                (setitimer-1)
                                                (header-requested-2 ?fd))
                                        (and    (not (command-received-server ?fd))
                                                (not (setitimer-1))
                                                (not (header-requested-2 ?fd))
                                                (header-requested-3 ?fd)))
                                ; request body
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (command-received-server ?fd)
                                                (setitimer-1)
                                                (header-requested-3 ?fd)
                                                (exists (?fd2 - fd) (data-sent-fetchmail ?fd2)))
                                        (and    (not (command-received-server ?fd))
                                                (not (setitimer-1))
                                                (not (header-requested-3 ?fd))
                                                (body-requested-server ?fd)))
                                ; request storage or next body chunk
                                (when   (and    (not (= ?res nFAIL))
                                                (imap-connection ?fd)
                                                (command-received-server ?fd)
                                                (setitimer-1)
                                                (body-requested-server ?fd)
                                                (exists (?fd2 - fd) (data-sent-fetchmail ?fd2)))
                                        (and    (not (command-received-server ?fd))
                                                (not (setitimer-1))))
                                ; storage ack
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n34) 
                                                (smtp-connection ?fd)
                                                (storing-email-2 ?fd)) 
                                        (and    (not (storing-email-2 ?fd))
                                                (fetchmail-server-email-transferred)))
                        )
    )


   	(:action write
        :parameters     (?fd - fd ?res - integer)
        :precondition   ()
        :effect                 ; SMTP CONNECTION
                                ; received MAIL FROM -> ack MAIL FROM
                        (and    (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (mail-from-received ?fd)
                                                (= ?res n14))  
                                        (mail-from-ack ?fd))
                                ; received RCPT TO -> ack RCPT TO
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (rcpt-to-received ?fd)
                                                (= ?res n14)  
                                                (exists (?fd2 - fd) (cleanup-flags-178-sent ?fd2)))
                                        (and    (not (rcpt-to-received ?fd))
                                                (rcpt-to-ack ?fd)))
                                ; received DATA -> sending end of data flag
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (data-received ?fd)
                                                (ioctl-done ?fd)
                                                (= ?res n37))  
                                        (and    (not (data-received ?fd))
                                                (not (ioctl-done ?fd))
                                                (end-data-flag-sent ?fd)))
                                ; received MAIL FROM -> sending end of data flag
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (mail-from-received ?fd)
                                                (ioctl-done ?fd)
                                                (or (= ?res n37) (= ?res n65)))  
                                        (and    (not (mail-from-received ?fd))
                                                (not (ioctl-done ?fd))
                                                (end-data-flag-sent ?fd)))
                                ; ack email
                                (when   (and    (not (= ?res nFAIL))
                                                (not (data-read-smtpd ?fd))
                                                (exists (?fd2 - fd) (cleanup-done ?fd2)))
                                        (and    (smtpd-email-transferred)
                                                (not (email-in-transfer ?fd))))
                                ; CLEANUP
                                ; received queuing_id
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (cleanup ?fd)
                                                (cleanup-queue-id-received ?fd))
                                        (and    (not (cleanup-queue-id-received ?fd))
                                                (cleanup-flags-178-sent ?fd)))
                                ; received M.N..Received-SPF:
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (cleanup ?fd)
                                                (cleanup-flags-178-sent ?fd)
                                                (exists (?fd2 - fd) (init-transfer ?fd2)))
                                        (and    (not (cleanup-flags-178-sent ?fd))
                                                (transfer-started ?fd)))
                                ; start queuing email
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (transfer-started ?fd)
                                                (exists (?fd2 - fd) (and (smtp-connection ?fd2) (data-read-smtpd ?fd2))))
                                        (and    (data-queued ?fd)
                                                (not (transfer-started ?fd))))
                                ; queuing email
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd)
                                                (exists (?fd2 - fd) (and (smtp-connection ?fd2) (data-read-smtpd ?fd2))))
                                        (data-queued ?fd))
                                (forall (?fd2 - fd) 
                                        (when   (and (smtp-connection ?fd2) (data-read-smtpd ?fd2))
                                                (not (data-read-smtpd ?fd2))))
                                ; RESET event  
                                (when   (and    (not (= ?res nFAIL))
                                                (event-received ?fd))  
                                        (not (event-received ?fd)))
								; ------------------------------------------
    							; FETCHMAIL GMX
    							; ------------------------------------------
								; request header
                                (when   (and    (not (= ?res nFAIL))
                                                (or (= ?res n58) (= ?res n59) (= ?res n60) (= ?res n62))
                                                (imap-connection ?fd)
                                                (not (email-in-transfer ?fd)))
                                        (and    (header-requested-fetchmail ?fd)
                                                (email-in-transfer ?fd)))
                                ; request body
                                (when   (and    (not (= ?res nFAIL))
                                                (or (= ?res n60) (= ?res n61) (= ?res n62))
                                                ;(= ?res n62)
                                                (setitimer-1)
                                                (imap-connection ?fd)
                                                (header-ack ?fd))
                                        (and    (not (setitimer-1))
                                                (not (header-ack ?fd))
                                                (body-requested-fetchmail ?fd)))
                                ; start body chunk transfer to subprocess
                                (forall (?fd2 - fd)
                                        (when   (and    (not (= ?res nFAIL))
                                                        (setitimer-n)
                                                        (imap-connection ?fd2)
                                                        (reading-body ?fd2)
                                                        (or     (body-chunk-read-1 ?fd2) (body-chunk-read-2 ?fd2) 
                                                                (body-chunk-read-3 ?fd2) (body-chunk-read-4 ?fd2))
                                                        (pipe-fd ?fd))
                                                (and    (not (setitimer-n))
                                                        (not (body-chunk-read-1 ?fd2))
                                                        (not (body-chunk-read-2 ?fd2))
                                                        (not (body-chunk-read-3 ?fd2))
                                                        (not (body-chunk-read-4 ?fd2))
                                                        (not (body-chunk-written-3 ?fd))
                                                        (not (body-chunk-written-4 ?fd))
                                                        (body-chunk-written-1 ?fd))))
                                ; body chunk transfer 2
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-n)
                                                (pipe-fd ?fd)
                                                (body-chunk-written-1 ?fd))
                                        (and    (not (setitimer-n))
                                                (not (body-chunk-written-1 ?fd))
                                                (body-chunk-written-2 ?fd)))
                                ; body chunk transfer 3
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-n)
                                                (pipe-fd ?fd)
                                                (body-chunk-written-2 ?fd))
                                        (and    (not (setitimer-n))
                                                (not (body-chunk-written-2 ?fd))
                                                (body-chunk-written-3 ?fd)))
                                ; body chunk transfer 4
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-n)
                                                (pipe-fd ?fd)
                                                (body-chunk-written-3 ?fd))
                                        (and    (not (setitimer-n))
                                                (not (body-chunk-written-3 ?fd))
                                                (body-chunk-written-4 ?fd)))
                                ; end body transfer to subprocess
                                (when   (and    (not (= ?res nFAIL))
                                                (setitimer-1)
                                                (pipe-fd ?fd)
                                                (exists (?fd2 - fd)
                                                        (and    (imap-connection ?fd2)
                                                                (body-sent-fetchmail ?fd2))))
                                        (and    (not    (setitimer-1))
                                                (not    (body-chunk-written-2 ?fd))
                                                (not    (body-chunk-written-3 ?fd))
                                                (not    (body-chunk-written-4 ?fd))
                                                (body-sent-fetchmail ?fd)))
                                ; write to fetchmail log file
                                (when   (and    (not (= ?res nFAIL))
                                                (rt-sigaction-2)
                                                (subprocess-ended)
                                                (related-file ?fd fetchmail_logfile))
                                        (and    (not (rt-sigaction-2))
                                                (not (subprocess-ended))
                                                (written-to-logs)))
                                ; request storage
                                (when   (and    (not (= ?res nFAIL))
                                                (or (= ?res n59) (= ?res n60) (= ?res n61))
                                                (imap-connection ?fd)
                                                (body-sent-fetchmail ?fd)
                                                (written-to-logs))
                                        (and    (not (body-sent-fetchmail ?fd))
                                                (not (written-to-logs))
                                                (storage-requested-fetchmail ?fd)))
								; ------------------------------------------
    							; IMAP LOGIN
    							; ------------------------------------------
    							; writing data transfer
                                (forall (?fd2 - fd)
                                        (when   (and    (not (= ?res nFAIL))
                                                        (local-socket ?fd2)
                                                        (fetching-data ?fd2)
                                                        (data-read-imaplogin ?fd2)
                                                        (imap-connection ?fd)
                                                        (fetching-data ?fd)
                                                        (not (data-sent ?fd)))
                                                (and    (not (data-read-imaplogin ?fd2))
                                                        (data-sent ?fd))))
                                ; ack fetch complete
                                (when   (and    (not (= ?res nFAIL))
                                                (setsockopt-done)
                                                (exists (?fd2 - fd)
                                                        (and    (local-socket ?fd2)
                                                                (end-fetching-header-2 ?fd2)))
                                                (imap-connection ?fd)
                                                (end-fetching-header ?fd))
                                        (and    (not (setsockopt-done))
                                                (not (end-fetching-header ?fd))
                                                (end-fetching-header-2 ?fd)))
                                ; storing email
                                (when   (and    (not (= ?res nFAIL))
                                                (or (= ?res n121) (= ?res n147))
                                                (setsockopt-done)
                                                (exists (?fd2 - fd)
                                                        (and    (local-socket ?fd2)
                                                                (storing-email ?fd2)))
                                                (imap-connection ?fd)
                                                (storage-requested-imaplogin ?fd))
                                        (and    (not (setsockopt-done))
                                                (not (storage-requested-imaplogin ?fd))
                                                (storing-email ?fd)))
                                ; expunging email
                                (when   (and    (not (= ?res nFAIL))
                                                (setsockopt-done)
                                                (exists (?fd2 - fd)
                                                        (and    (local-socket ?fd2)
                                                                (expunging-email ?fd2)))
                                                (imap-connection ?fd)
                                                (expunge-requested ?fd))
                                        (and    (not (setsockopt-done))
                                                (not (expunge-requested ?fd))
                                                (expunging-email ?fd)))
                                ; ------------------------------------------
                                ; FETCHMAIL SERVER
                                ; ------------------------------------------
                                ; mail from
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (not (email-in-transfer ?fd)))
                                        (and    (not (setitimer-1))
                                                (mail-from-sent ?fd)
                                                (email-in-transfer ?fd)))
                                ; rcpt to
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (mail-from-ack-2 ?fd))
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (mail-from-ack-2 ?fd))
                                                (rcpt-to-sent ?fd)))
                                ; data
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n6) 
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (rcpt-to-ack-2 ?fd))
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (rcpt-to-ack-2 ?fd))
                                                (end-data-flag-sent-fetchmail ?fd)))
                                ; data-info1
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (rt-sigaction-1)
                                                (end-data-flag-ack-2 ?fd)) 
                                        (and    (not (setitimer-1))
                                                (not (rt-sigaction-1))
                                                (not (end-data-flag-ack-2 ?fd))
                                                (data-sent-fetchmail-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (data-sent-fetchmail-1 ?fd)
                                                (not (data-info1-sent ?fd)))
                                        (and    (not (data-sent-fetchmail-1 ?fd))
                                                (data-sent-fetchmail-2 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (data-sent-fetchmail-2 ?fd)
                                                (not (data-info1-sent ?fd)))
                                        (and    (not (data-sent-fetchmail-2 ?fd))
                                                (data-info1-sent ?fd)))
                                ; data-info2
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (data-info1-sent ?fd)
                                                (stat-localtime-2))
                                        (and    (not (stat-localtime-2))
                                                (data-sent-fetchmail-1 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (data-info1-sent ?fd)
                                                (data-sent-fetchmail-1 ?fd))
                                        (and    (not (data-sent-fetchmail-1 ?fd))
                                                (data-sent-fetchmail-2 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n2)
                                                (smtp-connection ?fd)
                                                (data-info1-sent ?fd)
                                                (data-sent-fetchmail-2 ?fd))
                                        (and    (not (data-sent-fetchmail-2 ?fd))
                                                (not (data-info1-sent ?fd))
                                                (data-info2-sent ?fd)))
                                ; request header
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n60)
                                                (imap-connection ?fd)
                                                (or (setitimer-1) (setitimer-3))
                                                (header-requested-1 ?fd))
                                        (and    (not (setitimer-1))
                                                (not (setitimer-3))
                                                (not (header-requested-1 ?fd))
                                                (header-requested-2 ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n60)
                                                (imap-connection ?fd)
                                                (setitimer-n)
                                                (exists (?fd2 - fd) (data-info2-sent ?fd2)))
                                        (and    (not (setitimer-n))
                                                (header-requested-2 ?fd)))
                                ; init transfer header
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-3)
                                                (exists (?fd2 - fd) (header-requested-3 ?fd2))
                                                (data-info2-sent ?fd))
                                        (and    (not (setitimer-3))
                                                (not (data-info2-sent ?fd))
                                                (init-transfer-fetchmail ?fd)))
                                ; init transfer body
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-1)
                                                (exists (?fd2 - fd) (body-requested-server ?fd2))
                                                (data-sent-fetchmail ?fd))
                                        (and    (not (setitimer-1))
                                                (not (data-sent-fetchmail ?fd))
                                                (init-transfer-fetchmail ?fd)))
                                ; transfer data
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-2)
                                                (init-transfer-fetchmail ?fd)
                                                (not (data-sent-fetchmail ?fd)))
                                        (and    (not (setitimer-2))
                                                (not (init-transfer-fetchmail ?fd))
                                                (data-sent-fetchmail ?fd)))
                                (when   (and    (not (= ?res nFAIL))
                                                (smtp-connection ?fd)
                                                (setitimer-2)
                                                (data-sent-fetchmail ?fd))
                                        (not (setitimer-2)))
                                ; storage
                                (when   (and    (not (= ?res nFAIL))
                                                (= ?res n3)
                                                (smtp-connection ?fd)
                                                (or (setitimer-3) (setitimer-n))
                                                (exists (?fd2 - fd) 
                                                        (or (header-requested-3 ?fd2) (body-requested-server ?fd2))))
                                        (and    (not (setitimer-3))
                                                (not (setitimer-n))
                                                (not (data-sent-fetchmail ?fd))
                                                (storing-email-1 ?fd)))
                            )
    )
)